# Adding UART debug output
The [Tiva C user guide][user-guide] shows that UART0 is connected to the ICDI through pins `PA0` (RX) and `PA1` (TX) of the MCU. Section 14.4 describes how to initialise and configure the UART:
1. Enable the UART module using the `RCGCUART` register.
2. Enable the clock to the appropriate GPIO module via the `RCGCGPIO` register.
3. Set the GPIO `AFSEL` bits for the appropriate pins.
4. Configure the GPIO current level and/or slew rate as specified for the mode selected.
5. Configure the `PMCn` fields in the `GPIOPCTL` register to assign the UART signals to the appropriate pins.

## Troubleshooting
Reading the serial output using `screen /dev/cu.usbmodem0E234C151 115200` resulted in garbage output. The output appeared every second, as the UART was programmed to do, but contained unprintable characters. Switching the UART output from UART0 to UART2, making the signal available on the launchpad header pins, and analysing it with a scope and protocol analyser proved helpful.

### Observed baud rate didn't match the programmed baud rate
Simplifying the code to have the UART only transmit the character `A` gave [this output](./observed-A.png) on a Digilent Analog Discovery (Legacy) oscilloscope. According to 14.3.3 Data Transmission in the [data sheet][datasheet] the correct bits of data are being sent: hold at 1 when not transmitting, drop to 0 for the start bit, 01000001 (LSB first), followed by holding at 1 for the stop bit. Not that `01000001` in binary is `65` which is the ASCII character `A`, as expected. Similarly, the ASCII bits for letters [`B` (`01000010`)](./observed-B.png) and [`C` (`01000011`)](./observed-C.png) can be generated by modifying the program.

However, viewing this data on the Analog Discovery's protocol analyser yielded a single garbage character for each transmission. Looking at [the timing in the scope](./observed-baud-rate.png) shows that the observed baud rate is closer to `1/0.000007s ~ 142900 Bd`. Switching the protocol analyser to use a baud rate of `142900` results in the protocol analyser reading the expected `A` character.

### Cause
The cause of this issue was, expectedly, the calculations for the `UARTIBRD` and `UARTFBRD` registers that are used to control the baud rate of the MCU's UART. Due to a misinterpretation of the data sheet, the system clock frequency was assumed to be `12.5 MHz` in the UART setup code. However, since the clock PLL (phase-locked loop) is disabled by default, the system clock is driven directly by the main oscillator (MOSC). The MOSC is an external `16 MHz` crystal (component Y2 in the schematic) on the launchpad board. Switching the system clock frequency constant in the code to `16 MHz` brings the observed baud rate down to the expected programmed value of `115200`. This also explains the initial timing inaccuracies observed in the [blink led exercise](/step-2-blink-led-systick/README.md). See [Clock sources and PLL in ARM Cortex M4](https://www.youtube.com/watch?v=2ou8FQ_7PdI) for a detailed explanation of the TM4C123GH6PM clock sources.

[user-guide]: /docs/tiva-c-launchpad-user-guide.pdf "Tiva C Launchpad User Guide"
[datasheet]: /docs/tm4c123gh6pm-datasheet.pdf "TM4C123GH6PM Data Sheet"
[observed-A]: ./observed-A.png
[observed-B]: ./observed-B.png
[observed-C]: ./observed-C.png
[observed-baud-rate]: ./observed-baud-rate.png
